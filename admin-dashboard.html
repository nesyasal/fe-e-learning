<!DOCTYPE html>
<html class="no-js" lang="zxx">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Admin Dashboard - Edumark</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- CSS here -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/css/font-awesome.min.css" />
    <link rel="stylesheet" href="assets/css/themify-icons.css" />
    <link rel="stylesheet" href="assets/css/animate.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/css/admin-dashboard.css" />
    <link rel="stylesheet" href="assets/css/edit-modal.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      /* Toast notifications */
      #toast-container {
        position: fixed;
        right: 18px;
        bottom: 18px;
        z-index: 1100;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .toast {
        background: #111827;
        color: #fff;
        padding: 10px 14px;
        border-radius: 8px;
        min-width: 200px;
        box-shadow: 0 6px 18px rgba(2, 6, 23, 0.2);
        opacity: 0;
        transform: translateY(10px);
        transition: all 220ms ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .toast.visible {
        opacity: 1;
        transform: translateY(0);
      }
      .toast-success {
        background: linear-gradient(90deg, #10b981, #06b6d4);
      }
      .toast-error {
        background: linear-gradient(90deg, #ef4444, #f97316);
      }
      .toast .toast-close {
        background: transparent;
        border: 0;
        color: inherit;
        font-size: 16px;
        cursor: pointer;
      }
    </style>
  </head>

  <body class="admin-body">
    <script>
      // Role guard: only admin can access this page
      (function () {
        try {
          const user = JSON.parse(localStorage.getItem("user") || "null");
          if (!user || user.role !== "admin") {
            alert("Akses ditolak: Halaman ini hanya untuk admin");
            window.location.href = "index.html";
          }
        } catch (e) {
          console.warn("Role guard parse error", e);
          window.location.href = "index.html";
        }
      })();
    </script>
    <script>
      // Role guard: only admin can access this page
      (function () {
        try {
          const user = JSON.parse(localStorage.getItem("user") || "null");
          if (!user || user.role !== "admin") {
            alert("Akses ditolak: Halaman ini hanya untuk admin");
            window.location.href = "not-found.html";
          }
        } catch (e) {
          console.warn("Role guard parse error", e);
          window.location.href = "not-found.html";
        }
      })();
    </script>
    <div class="admin-container">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <div class="logo">
          <img src="assets/img/logo.png" alt="Edumark Logo" class="logo-img" />
        </div>
        <nav class="admin-menu">
          <div class="menu-item active" onclick="showSection('overview', this)">
            <i class="fa fa-dashboard"></i>
            <span>Dashboard</span>
          </div>
          <div class="menu-item" onclick="showSection('courses', this)">
            <i class="fa fa-book"></i>
            <span>Kursus</span>
          </div>
          <div class="menu-item" onclick="showSection('users', this)">
            <i class="fa fa-users"></i>
            <span>Pengguna</span>
          </div>
          <div class="menu-item" onclick="showSection('feedback', this)">
            <i class="fa fa-comments"></i>
            <span>Feedback</span>
          </div>
          <div class="menu-item" onclick="showSection('settings', this)">
            <i class="fa fa-cog"></i>
            <span>Pengaturan</span>
          </div>
          <div class="menu-item" onclick="logout()">
            <i class="fa fa-sign-out"></i>
            <span>Keluar</span>
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <div class="admin-main">
        <!-- Top Bar -->
        <div class="admin-topbar">
          <h2 id="page-title">Dashboard</h2>
          <div class="admin-topbar-right">
            <div class="user-profile">
              <div class="user-avatar" id="user-avatar">AD</div>
              <div class="user-name" id="user-name">Admin</div>
            </div>
          </div>
        </div>

        <!-- Content Area -->
        <div class="admin-content">
          <!-- Overview Section -->
          <section class="dashboard-section active" id="overview">
            <!-- Stats Cards -->
            <div class="stats-container">
              <div class="stat-card users">
                <div class="stat-icon">
                  <i class="fa fa-users"></i>
                </div>
                <div class="stat-label">Total Pengguna</div>
                <div class="stat-value" id="total-users">0</div>
                <div class="stat-change">Sampai hari ini</div>
              </div>

              <div class="stat-card courses">
                <div class="stat-icon">
                  <i class="fa fa-book"></i>
                </div>
                <div class="stat-label">Total Kursus</div>
                <div class="stat-value" id="total-courses">0</div>
                <div class="stat-change">Kursus aktif</div>
              </div>
            </div>
          </section>

          <!-- Courses Section -->
          <section class="dashboard-section" id="courses">
            <div class="table-container">
              <h3>Kursus Terbitan</h3>
              <div class="table-responsive">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Judul</th>
                      <th>Instruktur</th>
                      <th>Status</th>
                      <th>Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="courses-published-table">
                    <tr>
                      <td colspan="5" class="empty-state">
                        <p>Tidak ada kursus terbit</p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <h3 style="margin-top: 28px">Kursus Draft / Belum Terbit</h3>
              <div class="table-responsive">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Judul</th>
                      <th>Instruktur</th>
                      <th>Status</th>
                      <th>Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="courses-draft-table">
                    <tr>
                      <td colspan="5" class="empty-state">
                        <p>Tidak ada kursus draft</p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Users Section -->
          <section class="dashboard-section" id="users">
            <div class="table-container">
              <h3>Daftar Pengguna</h3>
              <div class="table-responsive">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Nama Lengkap</th>
                      <th>Username</th>
                      <th>Email</th>
                      <th>Role</th>
                      <th>Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="users-table">
                    <tr>
                      <td colspan="6" class="empty-state">
                        <p>Tidak ada data pengguna</p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <div id="editUserModal" class="modal">
            <div class="modal-content">
              <span class="close-btn">&times;</span>
              <h3>Edit Pengguna</h3>
              <form id="editUserForm">
                <input type="hidden" id="edit-user-id" name="id" />

                <div class="form-group">
                  <label for="edit-fullname">Nama Lengkap</label>
                  <input type="text" id="edit-fullname" name="fullname" />
                </div>

                <div class="form-group">
                  <label for="edit-username">Username</label>
                  <input type="text" id="edit-username" name="username" />
                </div>

                <div class="form-group">
                  <label for="edit-email">Email</label>
                  <input type="email" id="edit-email" name="email" />
                </div>

                <div class="form-group">
                  <label for="edit-role">Role</label>
                  <select id="edit-role" name="role">
                    <option value="" selected>-- Tidak Diubah --</option>
                    <option value="admin">Admin</option>
                    <option value="instructor">Instructor</option>
                    <option value="user">User</option>
                  </select>
                </div>

                <button type="submit" class="btn-admin btn-primary-admin">
                  Simpan Perubahan
                </button>
              </form>
            </div>
          </div>

          <!-- Feedback Section -->
          <section class="dashboard-section" id="feedback">
            <div class="table-container">
              <h3>Semua Feedback</h3>
              <div
                class="feedback-filters"
                style="
                  margin-bottom: 20px;
                  display: flex;
                  gap: 10px;
                  flex-wrap: wrap;
                "
              >
                <select
                  id="filter-course"
                  style="
                    padding: 10px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-size: 14px;
                  "
                >
                  <option value="">Semua Kursus</option>
                </select>
                <select
                  id="filter-rating"
                  style="
                    padding: 10px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-size: 14px;
                  "
                >
                  <option value="">Semua Rating</option>
                  <option value="5">★★★★★ (5 Bintang)</option>
                  <option value="4">★★★★ (4 Bintang)</option>
                  <option value="3">★★★ (3 Bintang)</option>
                  <option value="2">★★ (2 Bintang)</option>
                  <option value="1">★ (1 Bintang)</option>
                </select>
              </div>
              <div class="table-responsive">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>User</th>
                      <th>Kursus</th>
                      <th>Rating</th>
                      <th>Komentar</th>
                      <th>Tanggal</th>
                    </tr>
                  </thead>
                  <tbody id="feedback-table">
                    <tr>
                      <td colspan="6" class="empty-state">
                        <p>Tidak ada data feedback</p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- Settings Section -->
          <section class="dashboard-section" id="settings">
            <div style="max-width: 700px">
              <div class="table-container">
                <h3>Pengaturan</h3>

                <form id="profile-form">
                  <div class="form-group">
                    <label for="admin-name">Nama Admin</label>
                    <input
                      id="admin-name"
                      type="text"
                      value="Administrator"
                      required
                    />
                  </div>

                  <div class="form-group">
                    <label for="admin-email">Email</label>
                    <input
                      id="admin-email"
                      type="email"
                      value="admin@edumark.com"
                      required
                    />
                  </div>

                  <button type="submit" class="btn-admin btn-primary-admin">
                    Simpan Profil
                  </button>
                </form>

                <form id="password-form" style="margin-top: 18px">
                  <h4>Ganti Password</h4>
                  <div class="form-group">
                    <label for="admin-current-password"
                      >Password Saat Ini</label
                    >
                    <input id="admin-current-password" type="password" />
                  </div>
                  <div class="form-group">
                    <label for="admin-new-password">Password Baru</label>
                    <input id="admin-new-password" type="password" />
                  </div>
                  <div class="form-group">
                    <label for="admin-new-password-confirm"
                      >Konfirmasi Password Baru</label
                    >
                    <input id="admin-new-password-confirm" type="password" />
                  </div>
                  <button type="submit" class="btn-admin btn-primary-admin">
                    Ganti Password
                  </button>
                </form>

                <div style="margin-top: 20px">
                  <button
                    id="delete-account-btn"
                    class="btn-admin btn-danger-admin"
                  >
                    Hapus Akun
                  </button>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Scripts -->
    <script src="assets/js/vendor/jquery-1.12.4.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script type="module">
      import {
        getAdminOverview,
        getPublishedCourses,
        getUnpublishedCourses,
        getAllCoursesByStatus,
        getAllUsers,
        updateUser as apiUpdateUser,
        deleteUser as apiDeleteUser,
        getAllFeedback,
        deleteFeedback as apiDeleteFeedback,
        getProfile,
        publishCourse,
        unpublishCourse,
        updateAdminProfile,
        changeAdminPassword,
        deleteAdminAccount,
      } from "./assets/js/api/dashboard.js";

      import { logoutUser } from "./assets/js/api/auth.js";

      // Global data store
      let dashboardData = {
        overview: {},
        courses: [],
        users: [],
        feedbacks: [],
      };

      // Normalize helper
      const getVal = (...vals) =>
        vals.find((v) => v !== undefined && v !== null && v !== "");

      // Normalize various API course responses into an array
      function normalizeCourses(resp) {
        if (!resp) return [];
        if (Array.isArray(resp)) return resp;
        if (resp.courses && Array.isArray(resp.courses)) return resp.courses;
        if (resp.data && Array.isArray(resp.data)) return resp.data;
        if (resp.items && Array.isArray(resp.items)) return resp.items;
        // If resp has a single course object keyed by id, return as array
        if (typeof resp === "object") {
          // try to detect object with numeric keys
          const arr = Object.values(resp).filter(
            (v) => v && typeof v === "object" && (v.id || v.ID || v.title)
          );
          if (arr.length) return arr;
        }
        return [];
      }

      // Get readable instructor name from various shapes
      function getInstructorName(instr) {
        if (!instr) return "-";
        if (typeof instr === "string") return instr;
        if (typeof instr === "object") {
          return (
            getVal(
              instr.name,
              instr.full_name,
              instr.username,
              instr.displayName,
              instr.email
            ) || "-"
          );
        }
        return String(instr);
      }

      // ----------------------------
      // Toast helper
      // ----------------------------
      function showToast(message, type = "info", timeout = 3500) {
        try {
          const container = document.getElementById("toast-container");
          if (!container) return alert(message);
          const el = document.createElement("div");
          el.className =
            "toast " +
            (type === "success"
              ? "toast-success"
              : type === "error"
              ? "toast-error"
              : "");
          el.innerHTML = `<div class="toast-message">${message}</div><button class="toast-close" aria-label="Close">&times;</button>`;
          container.appendChild(el);
          // show
          requestAnimationFrame(() => el.classList.add("visible"));
          el.querySelector(".toast-close").addEventListener("click", () => {
            el.classList.remove("visible");
            setTimeout(() => el.remove(), 220);
          });
          setTimeout(() => {
            el.classList.remove("visible");
            setTimeout(() => el.remove(), 220);
          }, timeout);
        } catch (e) {
          console.warn("Toast failed", e);
          alert(message);
        }
      }

      // ----------------------------
      // SweetAlert helpers
      // ----------------------------
      async function swConfirm(message, title = "Konfirmasi") {
        try {
          const result = await Swal.fire({
            title: title,
            text: message,
            icon: "question",
            showCancelButton: true,
            confirmButtonText: "Ya",
            cancelButtonText: "Batal",
            reverseButtons: true,
          });
          return !!result.isConfirmed;
        } catch (e) {
          console.warn("swConfirm failed", e);
          return false;
        }
      }

      function swNotify(message, icon = "success", timeout = 3000) {
        try {
          Swal.fire({
            toast: true,
            position: "bottom-end",
            icon: icon,
            title: message,
            showConfirmButton: false,
            timer: timeout,
            timerProgressBar: true,
          });
        } catch (e) {
          console.warn("swNotify failed", e);
          showToast(message, icon === "error" ? "error" : "success", timeout);
        }
      }

      // ----------------------------
      // INIT DASHBOARD
      // ----------------------------
      async function initDashboard() {
        document.querySelector(".admin-content").style.opacity = "0.6";

        try {
          // fetch overview, users and feedback in parallel
          const [overview, users, feedback] = await Promise.all([
            getAdminOverview(),
            getAllUsers(),
            getAllFeedback(),
          ]);

          dashboardData.overview = overview || {};
          dashboardData.users = users?.users || users || [];
          dashboardData.feedbacks = feedback?.feedbacks || feedback || [];

          // try to prefill profile fields
          try {
            const profile = await getProfile();
            if (profile) {
              const nameEl = document.getElementById("admin-name");
              const emailEl = document.getElementById("admin-email");
              if (nameEl)
                nameEl.value =
                  profile.full_name ||
                  profile.name ||
                  profile.username ||
                  nameEl.value;
              if (emailEl) emailEl.value = profile.email || emailEl.value;
            }
          } catch (e) {
            // non-fatal
            console.warn("Could not fetch profile to prefill settings", e);
          }

          // Try admin aggregated endpoint first
          try {
            const statusResp = await getAllCoursesByStatus();
            if (statusResp) {
              if (Array.isArray(statusResp)) {
                dashboardData.courses = statusResp;
              } else if (statusResp.published || statusResp.unpublished) {
                const pubs = normalizeCourses(statusResp.published || []);
                const unpubs = normalizeCourses(statusResp.unpublished || []);
                dashboardData.courses = [...pubs, ...unpubs];
              } else {
                dashboardData.courses = normalizeCourses(statusResp);
              }
            }
          } catch (e) {
            // fallback to separate endpoints
            try {
              const pub = await getPublishedCourses();
              const unpub = await getUnpublishedCourses();
              dashboardData.courses = [
                ...normalizeCourses(pub),
                ...normalizeCourses(unpub),
              ];
            } catch (e2) {
              console.warn(
                "Failed to fetch courses via admin endpoints, fallback to /courses",
                e2
              );
              const pubOnly = await getPublishedCourses();
              dashboardData.courses = normalizeCourses(pubOnly);
            }
          }
        } catch (err) {
          console.error("Error loading dashboard:", err);
        }

        document.querySelector(".admin-content").style.opacity = "1";

        loadOverview();
        loadCourses();
        loadUsers();
        loadFeedback();
        populateCourseFilter();
      }
      // showSection will be exposed after its declaration

      // ----------------------------
      // OVERVIEW
      // ----------------------------
      function loadOverview() {
        const d = dashboardData.overview;
        document.getElementById("total-users").textContent = d.total_users ?? 0;
        document.getElementById("total-courses").textContent =
          d.total_courses ?? 0;
      }

      // ----------------------------
      // COURSES LIST
      // ----------------------------
      function loadCourses() {
        const publishedTbody = document.getElementById(
          "courses-published-table"
        );
        const draftTbody = document.getElementById("courses-draft-table");
        publishedTbody.innerHTML = "";
        draftTbody.innerHTML = "";

        if (!dashboardData.courses.length) {
          publishedTbody.innerHTML = `<tr><td colspan="5" class="empty-state">Tidak ada kursus terbit</td></tr>`;
          draftTbody.innerHTML = `<tr><td colspan="5" class="empty-state">Tidak ada kursus draft</td></tr>`;
          return;
        }

        const published = dashboardData.courses.filter((c) => !!c.published);
        const drafts = dashboardData.courses.filter((c) => !c.published);

        if (!published.length) {
          publishedTbody.innerHTML = `<tr><td colspan="5" class="empty-state">Tidak ada kursus terbit</td></tr>`;
        } else {
          published.forEach((c) => {
            const id = getVal(c.id, c.ID);
            const row = `
              <tr>
                <td>#${id}</td>
                <td>${c.title || "-"}</td>
                <td>${getInstructorName(c.instructor)}</td>
                <td>Published</td>
                <td>
                  <button class="btn-admin btn-warning-admin" onclick="window.togglePublishCourse && window.togglePublishCourse('${id}', false)">Unpublish</button>
                  <button class="btn-admin btn-secondary-admin" onclick="window.viewCourseDetail && window.viewCourseDetail('${id}')">Detail</button>
                </td>
              </tr>`;
            publishedTbody.innerHTML += row;
          });
        }

        if (!drafts.length) {
          draftTbody.innerHTML = `<tr><td colspan="5" class="empty-state">Tidak ada kursus draft</td></tr>`;
        } else {
          drafts.forEach((c) => {
            const id = getVal(c.id, c.ID);
            const row = `
              <tr>
                <td>#${id}</td>
                <td>${c.title || "-"}</td>
                <td>${getInstructorName(c.instructor)}</td>
                <td>Draft</td>
                <td>
                  <button class="btn-admin btn-success-admin" onclick="window.togglePublishCourse && window.togglePublishCourse('${id}', true)">Publish</button>
                  <button class="btn-admin btn-secondary-admin" onclick="window.viewCourseDetail && window.viewCourseDetail('${id}')">Detail</button>
                </td>
              </tr>`;
            draftTbody.innerHTML += row;
          });
        }
      }

      // ----------------------------
      // USERS LIST
      // ----------------------------
      function loadUsers() {
        const tbody = document.getElementById("users-table");
        tbody.innerHTML = "";

        if (!dashboardData.users.length) {
          tbody.innerHTML = `<tr><td colspan="6" class="empty-state">Tidak ada pengguna</td></tr>`;
          return;
        }

        dashboardData.users.forEach((u) => {
          const id = getVal(u.id, u.ID);
          const name = getVal(u.fullname, u.full_name, u.username);
          const role = (u.role || "user").toUpperCase();

          tbody.innerHTML += `
            <tr>
              <td>#${id}</td>
              <td>${name}</td>
              <td>${u.username}</td>
              <td>${u.email}</td>
              <td><span class="status-badge">${role}</span></td>
              <td>
                <button class="btn-admin btn-secondary-admin" onclick="editUserModal('${id}')">Edit</button>
                <button class="btn-admin btn-danger-admin" onclick="deleteUserAction('${id}', '${name}')">Hapus</button>
              </td>
            </tr>`;
        });
      }

      // ----------------------------
      // FEEDBACK LIST
      // ----------------------------
      function loadFeedback() {
        const tbody = document.getElementById("feedback-table");
        tbody.innerHTML = "";

        if (!dashboardData.feedbacks || !dashboardData.feedbacks.length) {
          tbody.innerHTML = `<tr><td colspan="6" class="empty-state">Tidak ada feedback</td></tr>`;
          return;
        }

        const courseFilter =
          document.getElementById("filter-course")?.value || "";
        const ratingFilter =
          document.getElementById("filter-rating")?.value || "";

        const filtered = dashboardData.feedbacks.filter((f) => {
          // course id may appear in different shapes
          const fid = getVal(
            f.course_id,
            f.courseId,
            f.course && f.course.id,
            f.course && f.course.ID
          );

          if (courseFilter && String(fid) !== String(courseFilter))
            return false;
          if (ratingFilter && String(f.rating) !== String(ratingFilter))
            return false;
          return true;
        });

        if (!filtered.length) {
          tbody.innerHTML = `<tr><td colspan="6" class="empty-state">Tidak ada feedback sesuai filter</td></tr>`;
          return;
        }

        filtered.forEach((f) => {
          const id = getVal(f.id, f.ID);
          const userName =
            getVal(
              f.user_name,
              f.user && f.user.name,
              f.user && f.user.username
            ) || "-";
          const courseTitle =
            getVal(f.course_title, f.course && f.course.title) || "-";
          const rating = f.rating || 0;
          const dateStr = f.created_at
            ? new Date(f.created_at).toLocaleDateString("id-ID")
            : "-";

          tbody.innerHTML += `
            <tr>
              <td>#${id}</td>
              <td>${userName}</td>
              <td>${courseTitle}</td>
              <td>${"★".repeat(rating)}</td>
              <td>${f.comment || ""}</td>
              <td>${dateStr}</td>
            </tr>`;
        });
      }

      // ----------------------------
      // FILTER FEEDBACK BY COURSE
      // ----------------------------
      function populateCourseFilter() {
        const select = document.getElementById("filter-course");
        if (!select) return;

        // reset options (leave first default option)
        const first = select.querySelector('option[value=""]');
        select.innerHTML = "";
        if (first) select.appendChild(first);

        dashboardData.courses.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = getVal(c.id, c.ID) || "";
          opt.textContent = c.title || "-";
          select.appendChild(opt);
        });
      }

      // Attach change listeners for feedback filters
      (function attachFeedbackFilters() {
        const courseSel = document.getElementById("filter-course");
        const ratingSel = document.getElementById("filter-rating");
        if (courseSel) courseSel.addEventListener("change", loadFeedback);
        if (ratingSel) ratingSel.addEventListener("change", loadFeedback);
      })();

      // ----------------------------
      // EDIT USER
      // ----------------------------
      window.editUserModal = (id) => {
        const user = dashboardData.users.find((u) => getVal(u.id, u.ID) == id);
        if (!user) return showToast("User tidak ditemukan.", "error");

        document.getElementById("edit-user-id").value = id;
        document.getElementById("edit-fullname").value = getVal(
          user.fullname,
          user.full_name
        );
        document.getElementById("edit-username").value = user.username;
        document.getElementById("edit-email").value = user.email;
        document.getElementById("edit-role").value = user.role;

        document.getElementById("editUserModal").style.display = "block";
      };

      document
        .getElementById("editUserForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();

          const id = document.getElementById("edit-user-id").value;

          const payload = {
            full_name: document.getElementById("edit-fullname").value,
            username: document.getElementById("edit-username").value,
            email: document.getElementById("edit-email").value,
            role: document.getElementById("edit-role").value,
          };

          const confirmMsg = `Simpan perubahan untuk pengguna #${id}?`;
          const ok = await swConfirm(confirmMsg, "Simpan Perubahan");
          if (!ok) return;

          try {
            await apiUpdateUser(id, payload);
            swNotify("Pengguna berhasil diperbarui.", "success");
            // close modal and refresh data
            const editModal = document.getElementById("editUserModal");
            if (editModal) editModal.style.display = "none";
            // reload users list
            try {
              const users = await getAllUsers();
              dashboardData.users =
                users?.users || users || dashboardData.users;
            } catch (e) {
              // fallback: reload page
              setTimeout(() => location.reload(), 900);
              return;
            }
            loadUsers();
          } catch (err) {
            console.error(err);
            swNotify("Gagal memperbarui pengguna.", "error");
          }
        });

      // Edit modal close handlers
      (function attachEditModalHandlers() {
        const editModal = document.getElementById("editUserModal");
        if (!editModal) return;
        const closeBtn = editModal.querySelector(".close-btn");
        if (closeBtn)
          closeBtn.addEventListener("click", () => {
            editModal.style.display = "none";
          });
        window.addEventListener("click", (ev) => {
          if (ev.target === editModal) editModal.style.display = "none";
        });
      })();

      // ----------------------------
      // DELETE USER
      // ----------------------------
      window.deleteUserAction = async (id, name) => {
        const ok = await swConfirm(`Hapus user ${name}?`, "Hapus Pengguna");
        if (!ok) return;

        try {
          await apiDeleteUser(id);
          dashboardData.users = dashboardData.users.filter(
            (u) => getVal(u.id, u.ID) != id
          );
          loadUsers();
          swNotify("User berhasil dihapus.", "success");
        } catch (e) {
          console.error(e);
          swNotify("Gagal menghapus user.", "error");
        }
      };

      // ----------------------------
      // DELETE FEEDBACK
      // ----------------------------
      window.deleteFeedback = async (id) => {
        const ok = await swConfirm(`Hapus feedback #${id}?`, "Hapus Feedback");
        if (!ok) return;
        try {
          await apiDeleteFeedback(id);
          dashboardData.feedbacks = dashboardData.feedbacks.filter(
            (f) => getVal(f.id, f.ID) != id
          );
          loadFeedback();
          swNotify("Feedback berhasil dihapus.", "success");
        } catch (e) {
          console.error(e);
          swNotify("Gagal menghapus feedback.", "error");
        }
      };

      // Publish / Unpublish course action
      window.togglePublishCourse = async (courseId, publish) => {
        const name = publish ? "publish" : "unpublish";
        const ok = await swConfirm(
          `Anda yakin ingin ${name} kursus #${courseId}?`,
          publish ? "Publish Kursus" : "Unpublish Kursus"
        );
        if (!ok) return;
        try {
          if (publish) {
            await publishCourse(courseId);
          } else {
            await unpublishCourse(courseId);
          }

          // update local state
          dashboardData.courses = dashboardData.courses.map((c) => {
            const id = getVal(c.id, c.ID);
            if (String(id) === String(courseId)) {
              return Object.assign({}, c, { published: !!publish });
            }
            return c;
          });

          loadCourses();
          populateCourseFilter();
          swNotify(
            `Kursus berhasil di${publish ? "publish" : "unpublish"}.`,
            "success"
          );
        } catch (err) {
          console.error(err);
          swNotify(`Gagal melakukan ${name} kursus.`, "error");
        }
      };

      // ----------------------------
      // LOGOUT
      // ----------------------------
      window.logout = async () => {
        await logoutUser();
        localStorage.clear();
        window.location.href = "index.html";
      };

      // Show Section
      function showSection(sectionId, element) {
        // Hide all sections
        document.querySelectorAll(".dashboard-section").forEach((section) => {
          section.classList.remove("active");
        });

        // Remove active class from all menu items
        document.querySelectorAll(".menu-item").forEach((item) => {
          item.classList.remove("active");
        });

        // Show selected section
        document.getElementById(sectionId).classList.add("active");
        element.classList.add("active");

        // Update page title
        const titles = {
          overview: "Dashboard",
          courses: "Kursus",
          users: "Pengguna",
          feedback: "Feedback",
          settings: "Pengaturan",
        };
        document.getElementById("page-title").textContent = titles[sectionId];
      }

      // Expose to global scope for inline menu onclicks
      window.showSection = showSection;

      // Logout - call backend and clear token
      async function logout() {
        const ok = await swConfirm("Apakah Anda yakin ingin keluar?", "Logout");
        if (!ok) return;
        try {
          // Call backend logout (stateless acknowledgement)
          if (
            window.apiAuth &&
            typeof window.apiAuth.logoutUser === "function"
          ) {
            await window.apiAuth.logoutUser();
          }
        } catch (err) {
          console.warn(
            "Logout API failed, proceeding to clear local session",
            err
          );
        } finally {
          // Clear token and redirect to login
          try {
            localStorage.removeItem("token");
            localStorage.removeItem("user");
          } catch (e) {}
          swNotify("Anda telah logout.", "success");
          window.location.href = "index.html";
        }
      }

      // Settings Form Submit
      // Profile form submit
      document
        .getElementById("profile-form")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const payload = {
            full_name: document.getElementById("admin-name").value,
            email: document.getElementById("admin-email").value,
          };

          const ok = await swConfirm(
            "Simpan perubahan profil admin?",
            "Simpan Profil"
          );
          if (!ok) return;

          try {
            await updateAdminProfile(payload);
            swNotify("Profil berhasil diperbarui.", "success");
          } catch (err) {
            console.error(err);
            swNotify("Gagal memperbarui profil.", "error");
          }
        });

      // Password change submit
      document
        .getElementById("password-form")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const current = document.getElementById(
            "admin-current-password"
          ).value;
          const nw = document.getElementById("admin-new-password").value;
          const confirmPw = document.getElementById(
            "admin-new-password-confirm"
          ).value;
          if (!current || !nw)
            return swNotify(
              "Masukkan password saat ini dan password baru.",
              "error"
            );
          if (nw !== confirmPw)
            return swNotify("Konfirmasi password tidak cocok.", "error");

          const ok = await swConfirm(
            "Anda yakin ingin mengganti password admin?",
            "Ganti Password"
          );
          if (!ok) return;

          try {
            await changeAdminPassword({
              current_password: current,
              new_password: nw,
            });
            swNotify("Password berhasil diubah.", "success");
            document.getElementById("admin-current-password").value = "";
            document.getElementById("admin-new-password").value = "";
            document.getElementById("admin-new-password-confirm").value = "";
          } catch (err) {
            console.error(err);
            swNotify("Gagal mengubah password.", "error");
          }
        });

      // Delete account
      document
        .getElementById("delete-account-btn")
        ?.addEventListener("click", async () => {
          const ok = await swConfirm(
            "Anda yakin ingin menghapus akun ini? Tindakan ini tidak dapat dibatalkan.",
            "Hapus Akun"
          );
          if (!ok) return;
          try {
            await deleteAdminAccount();
            swNotify("Akun berhasil dihapus.", "success");
            localStorage.clear();
            setTimeout(() => (window.location.href = "index.html"), 800);
          } catch (err) {
            console.error(err);
            swNotify("Gagal menghapus akun.", "error");
          }
        });

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", initDashboard);
    </script>
  </body>
</html>
