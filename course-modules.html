<!DOCTYPE html>
<html class="no-js" lang="zxx">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Kelola Module - Edumark</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/css/font-awesome.min.css" />
    <link rel="stylesheet" href="assets/css/admin-dashboard.css" />
    <link rel="stylesheet" href="assets/css/course-modules.css" />
  </head>

  <body class="admin-body">
    <div class="modules-container">
      <a href="instructor-dashboard.html" class="back-link"
        >‚Üê Kembali ke Dashboard</a
      >

      <div class="header">
        <h2>
          Kelola Module
          <span
            id="course-title"
            style="color: #667eea; font-size: 18px"
          ></span>
        </h2>
        <button class="btn-add" onclick="openAddModuleModal()">
          <i class="fa fa-plus"></i> Tambah Module
        </button>
      </div>

      <div id="alert-error" class="alert alert-error"></div>
      <div id="alert-success" class="alert alert-success"></div>

      <div class="modules-list">
        <div id="modules-list-content">
          <div class="empty-state">
            <i class="fa fa-inbox"></i>
            <p>Belum ada module</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Module Modal -->
    <div id="module-modal" class="modal-backdrop">
      <div class="modal">
        <h3 id="modal-title">Tambah Module</h3>
        <form id="module-form">
          <div class="form-group">
            <label for="module-title">Judul Module *</label>
            <input
              type="text"
              id="module-title"
              required
              placeholder="Contoh: Pengenalan HTML"
            />
          </div>

          <div class="form-group">
            <label for="module-order">Urutan *</label>
            <input
              type="number"
              id="module-order"
              required
              placeholder="1"
              min="1"
            />
          </div>

          <div class="form-group">
            <label for="module-pdf">File PDF (Opsional)</label>
            <input type="file" id="module-pdf" accept=".pdf" />
            <small style="color: #666; display: block; margin-top: 5px"
              >Ukuran maksimal: 10MB</small
            >
          </div>

          <div class="modal-actions">
            <button
              type="button"
              class="btn-modal btn-modal-secondary"
              onclick="closeAddModuleModal()"
            >
              Batal
            </button>
            <button type="submit" class="btn-modal btn-modal-primary">
              Simpan Module
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Scripts -->
    <script src="assets/js/vendor/jquery-1.12.4.min.js"></script>
    <script type="module">
      import { addModule } from "./assets/js/api/instructor.js";

      let courseId = null;
      let modules = [];
      let editingModuleId = null;

      // Get course ID from URL params
      function getCourseIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("id");
      }

      async function loadModules() {
        courseId = getCourseIdFromUrl();
        if (!courseId) {
          showAlert("Course ID tidak ditemukan", "error");
          return;
        }

        document.getElementById(
          "course-title"
        ).textContent = `(Kursus #${courseId})`;

        // For now, load from localStorage or sample data
        // In production, fetch from API
        try {
          // TODO: Implement GET /instructor/courses/:id/modules endpoint
          modules = JSON.parse(
            localStorage.getItem(`course-${courseId}-modules`) || "[]"
          );
          renderModules();
        } catch (err) {
          console.error("Error loading modules:", err);
          renderModules();
        }
      }

      function renderModules() {
        const container = document.getElementById("modules-list-content");

        if (modules.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fa fa-inbox"></i>
              <p>Belum ada module. Klik "Tambah Module" untuk memulai.</p>
            </div>
          `;
          return;
        }

        const sorted = [...modules].sort(
          (a, b) => (a.order || 0) - (b.order || 0)
        );
        container.innerHTML = sorted
          .map(
            (m) => `
          <div class="module-item">
            <div class="module-info">
              <h4>#${m.order || "-"} ${m.title}</h4>
              <p>${m.pdf_url ? "üìÑ Ada PDF" : "Tanpa PDF"}</p>
            </div>
            <div class="module-actions">
              <button class="btn-sm btn-primary-sm" onclick="editModule(${
                m.id || "null"
              })">Edit</button>
              <button class="btn-sm btn-primary-sm" onclick="goToQuizzes(${
                m.id || "null"
              })">Quiz</button>
              <button class="btn-sm btn-danger-sm" onclick="deleteModule(${
                m.id || "null"
              })">Hapus</button>
            </div>
          </div>
        `
          )
          .join("");
      }

      window.openAddModuleModal = function () {
        editingModuleId = null;
        document.getElementById("modal-title").textContent = "Tambah Module";
        document.getElementById("module-form").reset();
        document.getElementById("module-modal").classList.add("active");
      };

      window.closeAddModuleModal = function () {
        document.getElementById("module-modal").classList.remove("active");
      };

      window.editModule = function (id) {
        const module = modules.find((m) => m.id === id);
        if (!module) {
          alert("Module tidak ditemukan");
          return;
        }
        editingModuleId = id;
        document.getElementById("modal-title").textContent = "Edit Module";
        document.getElementById("module-title").value = module.title;
        document.getElementById("module-order").value = module.order || 1;
        document.getElementById("module-modal").classList.add("active");
      };

      window.deleteModule = async function (id) {
        if (!confirm("Apakah Anda yakin ingin menghapus module ini?")) return;
        modules = modules.filter((m) => m.id !== id);
        localStorage.setItem(
          `course-${courseId}-modules`,
          JSON.stringify(modules)
        );
        renderModules();
        showAlert("Module berhasil dihapus", "success");
      };

      window.goToQuizzes = function (moduleId) {
        if (!moduleId) {
          showAlert("Simpan module terlebih dahulu", "error");
          return;
        }
        window.location.href = `course-quiz.html?courseId=${courseId}&moduleId=${moduleId}`;
      };

      document
        .getElementById("module-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const title = document.getElementById("module-title").value.trim();
          const order = parseInt(document.getElementById("module-order").value);
          const pdfFile = document.getElementById("module-pdf").files[0];

          if (!title || !order) {
            showAlert("Judul dan urutan harus diisi", "error");
            return;
          }

          try {
            // If editing, update; otherwise add new
            if (editingModuleId) {
              const moduleIdx = modules.findIndex(
                (m) => m.id === editingModuleId
              );
              if (moduleIdx !== -1) {
                modules[moduleIdx].title = title;
                modules[moduleIdx].order = order;
                if (pdfFile) {
                  // In real app, upload to server
                  modules[moduleIdx].pdf_url = `uploaded/${pdfFile.name}`;
                }
              }
            } else {
              const newModule = {
                id: Date.now(),
                title,
                order,
                pdf_url: pdfFile ? `uploaded/${pdfFile.name}` : null,
                course_id: courseId,
              };
              modules.push(newModule);
            }

            localStorage.setItem(
              `course-${courseId}-modules`,
              JSON.stringify(modules)
            );
            renderModules();
            closeAddModuleModal();
            showAlert(
              editingModuleId
                ? "Module berhasil diperbarui"
                : "Module berhasil ditambahkan",
              "success"
            );
          } catch (error) {
            console.error("Error:", error);
            showAlert("Gagal menyimpan module: " + error.message, "error");
          }
        });

      function showAlert(message, type) {
        const errorAlert = document.getElementById("alert-error");
        const successAlert = document.getElementById("alert-success");

        if (type === "error") {
          errorAlert.textContent = message;
          errorAlert.style.display = "block";
          successAlert.style.display = "none";
        } else {
          successAlert.textContent = message;
          successAlert.style.display = "block";
          errorAlert.style.display = "none";
        }
      }

      document.addEventListener("DOMContentLoaded", loadModules);
    </script>
  </body>
</html>
