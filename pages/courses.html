<!DOCTYPE html>
<html class="no-js" lang="zxx">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Edumark</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- <link rel="manifest" href="site.webmanifest"> -->
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="../assets/img/favicon.png"
    />
    <!-- Place favicon.ico in the root directory -->

    <!-- CSS here -->
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../assets/css/owl.carousel.min.css" />
    <link rel="stylesheet" href="../assets/css/magnific-popup.css" />
    <link rel="stylesheet" href="../assets/css/font-awesome.min.css" />
    <link rel="stylesheet" href="../assets/css/themify-icons.css" />
    <link rel="stylesheet" href="../assets/css/nice-select.css" />
    <link rel="stylesheet" href="../assets/css/flaticon.css" />
    <link rel="stylesheet" href="../assets/css/gijgo.css" />
    <link rel="stylesheet" href="../assets/css/animate.css" />
    <link rel="stylesheet" href="../assets/css/slicknav.css" />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <!-- <link rel="stylesheet" href="css/responsive.css"> -->

    <style>
      /* Star Rating Styles */
      .course-rating {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 12px 0;
        font-size: 0.95rem;
      }

      .star-rating {
        display: inline-flex;
        gap: 2px;
      }

      .star {
        font-size: 16px;
        color: #ddd;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .star.filled {
        color: #ffc107;
        text-shadow: 0 0 2px rgba(255, 193, 7, 0.5);
      }

      .star:hover {
        transform: scale(1.1);
      }

      .rating-text {
        color: #666;
        font-size: 0.9rem;
      }

      .rating-value {
        font-weight: 600;
        color: #333;
      }

      /* Rating Modal Styles */
      .rating-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .rating-modal-overlay.active {
        display: flex;
      }

      .rating-modal {
        background: white;
        border-radius: 12px;
        padding: 30px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .rating-modal h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 1.5rem;
      }

      .modal-star-rating {
        display: flex;
        gap: 8px;
        margin: 20px 0;
        justify-content: center;
      }

      .modal-star-rating .star {
        font-size: 36px;
        cursor: pointer;
      }

      .rating-form-group {
        margin: 20px 0;
      }

      .rating-form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
      }

      .rating-form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-family: inherit;
        resize: vertical;
        min-height: 100px;
      }

      .rating-form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .modal-buttons {
        display: flex;
        gap: 10px;
        margin-top: 25px;
      }

      .modal-buttons button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .modal-buttons .btn-submit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .modal-buttons .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      }

      .modal-buttons .btn-cancel {
        background: #f0f0f0;
        color: #333;
      }

      .modal-buttons .btn-cancel:hover {
        background: #e0e0e0;
      }

      .rating-info {
        font-size: 0.9rem;
        color: #999;
        text-align: center;
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
        min-height: 20px;
      }

      .rating-info.error {
        background: #fee;
        color: #dc3545;
      }

      .rating-info.success {
        background: #efe;
        color: #28a745;
      }
    </style>
  </head>

  <body>
    <!--[if lte IE 9]>
      <p class="browserupgrade">
        You are using an <strong>outdated</strong> browser. Please
        <a href="https://browsehappy.com/">upgrade your browser</a> to improve
        your experience and security.
      </p>
    <![endif]-->

    <!-- header-start -->
    <div id="header"></div>
    <!-- header-end -->
    <!-- bradcam_area_start -->
    <div class="bradcam_area breadcam_bg overlay2">
      <h3>Our Courses</h3>
    </div>
    <!-- bradcam_area_end -->

    <!-- popular_courses_start -->
    <div class="popular_courses plus_padding">
      <div class="container">
        <div class="row">
          <div class="col-xl-12">
            <div class="section_title text-center mb-100">
              <h3>All Courses</h3>
              <p>Browse and start learning from available courses</p>
            </div>
          </div>
        </div>

        <!-- COURSE LIST FROM API -->
        <div class="row" id="courses-container">
          <!-- injected by JS -->
        </div>
      </div>
    </div>
    <!-- popular_courses_end -->

    <!-- testimonial_area_start -->
    <div class="testimonial_area testimonial_bg_1 overlay">
      <div class="testmonial_active owl-carousel">
        <div class="single_testmoial">
          <div class="container">
            <div class="row">
              <div class="col-xl-12">
                <div class="testmonial_text text-center">
                  <div class="author_img">
                    <img src="../assets/img/testmonial/author_img.png" alt="" />
                  </div>
                  <p>
                    "Working in conjunction with humanitarian aid <br />
                    agencies we have supported programmes to <br />
                    alleviate. human suffering.
                  </p>
                  <span>- Jquileen</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="single_testmoial">
          <div class="container">
            <div class="row">
              <div class="col-xl-12">
                <div class="testmonial_text text-center">
                  <div class="author_img">
                    <img src="../assets/img/testmonial/author_img.png" alt="" />
                  </div>
                  <p>
                    "Working in conjunction with humanitarian aid <br />
                    agencies we have supported programmes to <br />
                    alleviate. human suffering.
                  </p>
                  <span>- Jquileen</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- testimonial_area_end -->

    <!-- our_courses_start -->
    <div class="our_courses">
      <div class="container">
        <div class="row">
          <div class="col-xl-12">
            <div class="section_title text-center mb-100">
              <h3>Our Course Speciality</h3>
              <p>
                Your domain control panel is designed for ease-of-use and <br />
                allows for all aspects of your domains.
              </p>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-xl-3 col-md-6 col-lg-6">
            <div class="single_course text-center">
              <div class="icon">
                <i class="flaticon-art-and-design"></i>
              </div>
              <h3>Premium Quality</h3>
              <p>
                Your domain control panel is designed for ease-of-use <br />
                and <br />
                allows for all aspects of
              </p>
            </div>
          </div>
          <div class="col-xl-3 col-md-6 col-lg-6">
            <div class="single_course text-center">
              <div class="icon blue">
                <i class="flaticon-business-and-finance"></i>
              </div>
              <h3>Premium Quality</h3>
              <p>
                Your domain control panel is designed for ease-of-use <br />
                and <br />
                allows for all aspects of
              </p>
            </div>
          </div>
          <div class="col-xl-3 col-md-6 col-lg-6">
            <div class="single_course text-center">
              <div class="icon">
                <i class="flaticon-premium"></i>
              </div>
              <h3>Premium Quality</h3>
              <p>
                Your domain control panel is designed for ease-of-use <br />
                and <br />
                allows for all aspects of
              </p>
            </div>
          </div>
          <div class="col-xl-3 col-md-6 col-lg-6">
            <div class="single_course text-center">
              <div class="icon gradient">
                <i class="flaticon-crown"></i>
              </div>
              <h3>Premium Quality</h3>
              <p>
                Your domain control panel is designed for ease-of-use <br />
                and <br />
                allows for all aspects of
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- our_courses_end -->

    <!-- subscribe_newsletter_Start -->
    <div class="subscribe_newsletter">
      <div class="container">
        <div class="row">
          <div class="col-xl-6 col-lg-6">
            <div class="newsletter_text">
              <h3>Subscribe Newsletter</h3>
              <p>
                Your domain control panel is designed for ease-of-use and allows
                for all aspects of your
              </p>
            </div>
          </div>
          <div class="col-xl-5 offset-xl-1 col-lg-6">
            <div class="newsletter_form">
              <h4>Your domain control panel is</h4>
              <form action="#" class="newsletter_form">
                <input type="text" placeholder="Enter your mail" />
                <button type="submit">Sign Up</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- subscribe_newsletter_end -->

    <!-- footer -->
    <div id="footer"></div>
    <!-- footer -->

    <!-- Rating Modal -->
    <div id="rating-modal-overlay" class="rating-modal-overlay">
      <div class="rating-modal">
        <h3 id="modal-course-title">Rate This Course</h3>
        <p style="color: #666; margin-bottom: 15px;">How would you rate this course?</p>
        
        <div class="modal-star-rating" id="modal-star-rating">
          <!-- Stars will be inserted by JS -->
        </div>

        <div class="rating-form-group">
          <label for="feedback-text">Your Feedback (Optional)</label>
          <textarea id="feedback-text" placeholder="Share your thoughts about this course..."></textarea>
        </div>

        <div class="modal-buttons">
          <button class="btn-submit" id="submit-rating-btn">Submit Rating</button>
          <button class="btn-cancel" id="cancel-rating-btn">Cancel</button>
        </div>

        <div class="rating-info" id="rating-info"></div>
      </div>
    </div>

    <!-- form itself end-->
    <form id="test-form" class="white-popup-block mfp-hide">
      <div class="popup_box">
        <div class="popup_inner">
          <div class="logo text-center">
            <a href="#">
              <img src="../assets/img/form-logo.png" alt="" />
            </a>
          </div>
          <h3>Sign in</h3>
          <form action="#">
            <div class="row">
              <div class="col-xl-12 col-md-12">
                <input type="email" placeholder="Enter email" />
              </div>
              <div class="col-xl-12 col-md-12">
                <input type="password" placeholder="Password" />
              </div>
              <div class="col-xl-12">
                <button type="submit" class="boxed_btn_orange">Sign in</button>
              </div>
            </div>
          </form>
          <p class="doen_have_acc">
            Don’t have an account?
            <a class="dont-hav-acc" href="#test-form2">Sign Up</a>
          </p>
        </div>
      </div>
    </form>
    <!-- form itself end -->

    <!-- form itself end-->
    <form id="test-form2" class="white-popup-block mfp-hide">
      <div class="popup_box">
        <div class="popup_inner">
          <div class="logo text-center">
            <a href="#">
              <img src="../assets/img/form-logo.png" alt="" />
            </a>
          </div>
          <h3>Resistration</h3>
          <form action="#">
            <div class="row">
              <div class="col-xl-12 col-md-12">
                <input type="email" placeholder="Enter email" />
              </div>
              <div class="col-xl-12 col-md-12">
                <input type="password" placeholder="Password" />
              </div>
              <div class="col-xl-12 col-md-12">
                <input type="Password" placeholder="Confirm password" />
              </div>
              <div class="col-xl-12">
                <button type="submit" class="boxed_btn_orange">Sign Up</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </form>
    <!-- form itself end -->

    <!-- JS here -->
    <script src="../assets/js/vendor/modernizr-3.5.0.min.js"></script>
    <script src="../assets/js/vendor/jquery-1.12.4.min.js"></script>
    <script src="../assets/js/popper.min.js"></script>
    <script src="../assets/js/bootstrap.min.js"></script>
    <script src="../assets/js/owl.carousel.min.js"></script>
    <script src="../assets/js/isotope.pkgd.min.js"></script>
    <script src="../assets/js/ajax-form.js"></script>
    <script src="../assets/js/waypoints.min.js"></script>
    <script src="../assets/js/jquery.counterup.min.js"></script>
    <script src="../assets/js/imagesloaded.pkgd.min.js"></script>
    <script src="../assets/js/scrollIt.js"></script>
    <script src="../assets/js/jquery.scrollUp.min.js"></script>
    <script src="../assets/js/wow.min.js"></script>
    <script src="../assets/js/nice-select.min.js"></script>
    <script src="../assets/js/jquery.slicknav.min.js"></script>
    <script src="../assets/js/jquery.magnific-popup.min.js"></script>
    <script src="../assets/js/plugins.js"></script>
    <script src="../assets/js/gijgo.min.js"></script>

    <!--contact js-->
    <script src="../assets/js/contact.js"></script>
    <script src="../assets/js/jquery.ajaxchimp.min.js"></script>
    <script src="../assets/js/jquery.form.js"></script>
    <script src="../assets/js/jquery.validate.min.js"></script>
    <script src="../assets/js/mail-script.js"></script>

    <script type="module" src="../assets/js/main.js"></script>

    <script type="module">
      import { Header } from "../assets/js/components/public/header.js";
      import { Footer } from "../assets/js/components/public/footer.js";
      import {
        getPublishedCourses,
        getUserEnrollments,
        enrollCourse,
        isCourseEnrolled,
        getCourseRating,
        submitCourseRating,
      } from "../assets/js/api/student.js";

      document.addEventListener("DOMContentLoaded", async () => {
        console.log("DOM loaded, initializing courses page");
        document.getElementById("header").innerHTML = Header();
        document.getElementById("footer").innerHTML = Footer();
        console.log("Header and footer loaded, loading courses...");
        await loadCourses();
        console.log("Courses loading completed");
      });

      async function loadCourses() {
        const container = document.getElementById("courses-container");
        container.innerHTML =
          '<div class="col-12 text-center">Loading courses...</div>';

        const user = JSON.parse(localStorage.getItem("user") || "null");
        const isLoggedIn = !!user;
        console.log("User logged in:", isLoggedIn);

        let enrollments = [];
        if (isLoggedIn) {
          try {
            enrollments = await getUserEnrollments();
            console.log("Enrollments loaded:", enrollments);
          } catch (e) {
            console.error("Failed to load enrollments:", e);
            enrollments = [];
          }
        }

        let courses = [];
        try {
          const response = await getPublishedCourses();
          console.log("Raw API response:", response);
          console.log("Response type:", typeof response);
          console.log("Is array:", Array.isArray(response));

          // Handle different response formats
          if (Array.isArray(response)) {
            courses = response;
          } else if (response && typeof response === "object") {
            if (response.courses && Array.isArray(response.courses)) {
              courses = response.courses;
            } else if (response.data && Array.isArray(response.data)) {
              courses = response.data;
            } else if (response.results && Array.isArray(response.results)) {
              courses = response.results;
            } else {
              console.warn("Unexpected object format:", Object.keys(response));
              courses = [];
            }
          } else {
            console.warn("Unexpected response type:", typeof response);
            courses = [];
          }
          console.log("Final parsed courses:", courses);
        } catch (e) {
          console.error("Failed to load courses:", e);
          courses = [];
        }

        // Clear loading
        container.innerHTML = "";

        if (!courses.length) {
          container.innerHTML = `
            <div class="col-12 text-center text-muted">
              No courses available
            </div>
          `;
          return;
        }

        const images = ["1.png", "2.png", "3.png", "4.png", "5.png", "6.png"];

        for (const course of courses) {
          const enrolled = isLoggedIn
            ? isCourseEnrolled(course.id, enrollments)
            : false;

          const card = document.createElement("div");
          card.className = "col-xl-4 col-lg-4 col-md-6";

          // Load rating if enrolled
          let ratingHTML = "";
          if (enrolled) {
            try {
              const ratingData = await getCourseRating(course.id);
              if (ratingData && ratingData.rating) {
                const stars = "★".repeat(ratingData.rating) + "☆".repeat(5 - ratingData.rating);
                ratingHTML = `
                  <div class="course-rating">
                    <div class="star-rating">
                      ${stars}
                    </div>
                    <span class="rating-text">Your rating: <span class="rating-value">${ratingData.rating}/5</span></span>
                  </div>
                `;
              } else {
                ratingHTML = `
                  <div class="course-rating" style="cursor: pointer;" onclick="openRatingModal('${course.id}', '${course.title}')">
                    <div class="star-rating" id="rate-stars-${course.id}">
                      ☆☆☆☆☆
                    </div>
                    <span class="rating-text" style="color: #667eea; font-weight: 500;">Click to rate</span>
                  </div>
                `;
              }
            } catch (e) {
              console.log("No rating data for course", course.id);
              ratingHTML = `
                <div class="course-rating" style="cursor: pointer;" onclick="openRatingModal('${course.id}', '${course.title}')">
                  <div class="star-rating" id="rate-stars-${course.id}">
                    ☆☆☆☆☆
                  </div>
                  <span class="rating-text" style="color: #667eea; font-weight: 500;">Click to rate</span>
                </div>
              `;
            }
          }

          card.innerHTML = `
            <div class="single_courses">
              <div class="thumb">
                <a href="course_detail.html?id=${course.id}">
                  <img src="../assets/img/courses/${
                    images[Math.floor(Math.random() * images.length)]
                  }" alt="${course.title}">
                </a>
              </div>

              <div class="courses_info">
                <span>Course</span>
                <h3>
                  <a href="course_detail.html?id=${course.id}">
                    ${course.title}
                  </a>
                </h3>

                <p style="font-size:13px;color:#6b7280">
                  ${course.description || ""}
                </p>

                ${ratingHTML}

                <div style="margin-top:12px">
                  ${
                    !isLoggedIn
                      ? `<button class="boxed_btn_orange" onclick="window.location.href='#test-form'">
                          Login to Enroll
                        </button>`
                      : enrolled
                      ? `<button class="boxed_btn_orange" onclick="window.location.href='course_details.html?id=${course.id}'">
                          Start Learning
                        </button>`
                      : `<button class="boxed_btn_orange enroll-btn" data-id="${course.id}">
                          Enroll Now
                        </button>`
                  }
                </div>
              </div>
            </div>
          `;

          container.appendChild(card);
        }

        // enroll button handler
        document.querySelectorAll(".enroll-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = e.target.dataset.id;
            e.target.disabled = true;
            e.target.textContent = "Enrolling...";
            try {
              await enrollCourse(id);
              window.location.reload();
            } catch {
              alert("Enroll failed");
              e.target.disabled = false;
              e.target.textContent = "Enroll Now";
            }
          });
        });
      }

      // Global Rating Modal Functions
      let currentCourseId = null;
      let currentStarRating = 0;

      window.openRatingModal = function(courseId, courseTitle) {
        console.log("Opening rating modal for course:", courseId, courseTitle);
        
        if (!courseId) {
          alert("Error: Course ID is missing");
          return;
        }
        
        currentCourseId = courseId;
        currentStarRating = 0;
        
        document.getElementById("modal-course-title").textContent = `Rate "${courseTitle}"`;
        document.getElementById("feedback-text").value = "";
        document.getElementById("rating-info").textContent = "";
        
        renderStars();
        document.getElementById("rating-modal-overlay").classList.add("active");
      };

      function renderStars() {
        try {
          const container = document.getElementById("modal-star-rating");
          if (!container) {
            console.error("Modal star rating container not found");
            return;
          }
          
          container.innerHTML = "";
          
          for (let i = 1; i <= 5; i++) {
            const star = document.createElement("span");
            star.className = "star" + (i <= currentStarRating ? " filled" : "");
            star.textContent = "★";
            star.style.cursor = "pointer";
            star.addEventListener("click", () => {
              currentStarRating = i;
              renderStars();
            });
            star.addEventListener("mouseover", () => {
              const allStars = container.querySelectorAll(".star");
              allStars.forEach((s, idx) => {
                s.classList.toggle("filled", idx < i);
              });
            });
            
            container.appendChild(star);
          }
          
          container.addEventListener("mouseleave", renderStars);
        } catch (e) {
          console.error("Error rendering stars:", e);
        }
      }

      document.getElementById("submit-rating-btn").addEventListener("click", async () => {
        if (currentStarRating === 0) {
          document.getElementById("rating-info").textContent = "Please select a rating";
          document.getElementById("rating-info").style.color = "#dc3545";
          return;
        }

        if (!currentCourseId) {
          document.getElementById("rating-info").textContent = "Error: Course ID missing";
          document.getElementById("rating-info").style.color = "#dc3545";
          return;
        }

        const feedback = document.getElementById("feedback-text").value;
        const btn = document.getElementById("submit-rating-btn");
        const infoDiv = document.getElementById("rating-info");
        
        btn.disabled = true;
        btn.textContent = "Submitting...";
        infoDiv.textContent = "Submitting your rating...";
        infoDiv.style.color = "#666";

        try {
          console.log("Submitting rating:", { courseId: currentCourseId, rating: currentStarRating, feedback });
          const result = await submitCourseRating(currentCourseId, currentStarRating, feedback);
          console.log("Rating submission result:", result);
          
          infoDiv.textContent = "✓ Rating submitted successfully!";
          infoDiv.style.color = "#28a745";
          
          setTimeout(() => {
            document.getElementById("rating-modal-overlay").classList.remove("active");
            window.location.reload();
          }, 1500);
        } catch (e) {
          console.error("Rating submission failed:", e);
          console.error("Error details:", e.message);
          
          let errorMsg = "Failed to submit rating";
          if (e.message.includes("401") || e.message.includes("Unauthorized")) {
            errorMsg = "Your session expired. Please refresh and try again.";
          } else if (e.message.includes("404")) {
            errorMsg = "Rating endpoint not found. Please contact support.";
          } else if (e.message) {
            errorMsg = e.message;
          }
          
          infoDiv.textContent = "✗ " + errorMsg;
          infoDiv.style.color = "#dc3545";
          btn.disabled = false;
          btn.textContent = "Submit Rating";
        }
      });

      document.getElementById("cancel-rating-btn").addEventListener("click", () => {
        document.getElementById("rating-modal-overlay").classList.remove("active");
      });

      // Close modal when clicking outside
      document.getElementById("rating-modal-overlay").addEventListener("click", (e) => {
        if (e.target.id === "rating-modal-overlay") {
          document.getElementById("rating-modal-overlay").classList.remove("active");
        }
      });
    </script>
  </body>
</html>
